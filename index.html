<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador v29: PDF Vertical Formal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ========================================= */
        /* ESTILOS GENERALES (SIN CAMBIOS)           */
        /* ========================================= */
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f6f8; color: #333; }
        .main-wrapper { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .panel-izq { flex: 1; min-width: 320px; }
        .panel-der { flex: 2; min-width: 650px; }
        h2 { margin-top: 0; font-size: 1.2rem; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h3 { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; margin-top: 20px; }
        h4 { margin: 0 0 10px 0; color: #27ae60; font-size: 0.95rem; text-transform: uppercase; border-bottom: 1px solid #e9f7ef; padding-bottom: 5px; }
        label { display: block; font-weight: 700; font-size: 0.75rem; margin-bottom: 4px; color: #555; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 0.95rem; }
        .row-inputs { display: flex; gap: 10px; }
        .row-inputs > div { flex: 1; }
        .btn-calc { background: #2c3e50; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 10px; }
        .btn-aceptar { background: #27ae60; margin-top: 20px; }
        .btn-confirmar-costos { background: #8e44ad; color: white; width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .btn-generar-propuesta { background: #2980b9; color: white; width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; }
        .btn-reiniciar { background: #95a5a6; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; margin-top: 20px; cursor: pointer; transition: background 0.3s; }
        .area-visual { display: flex; gap: 30px; justify-content: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #ccc; }
        #zona-pallet { border: 2px solid #333; background: #ecf0f1; position: relative; margin: 0 auto; }
        .caja { position: absolute; background: #e67e22; border: 1px solid #fff; box-sizing: border-box; font-size: 9px; color: white; display: flex; justify-content: center; align-items: center; }
        .caja.rotada { background: #d35400; }
        #zona-lateral { width: 70px; background: rgba(0,0,0,0.05); border-bottom: 6px solid #8d6e63; display: flex; flex-direction: column-reverse; align-items: center; }
        .capa { width: 100%; background: linear-gradient(to right, #e67e22, #d35400); border: 1px solid white; color: white; text-align: center; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .mapa-contenedor { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #dfe6e9; padding: 15px; border: 2px dashed #b2bec3; border-radius: 6px; max-width: 450px; margin: 0 auto; }
        .posicion-pallet { background: #27ae60; color: white; padding: 8px; text-align: center; border-radius: 4px; border: 1px solid #1e8449; display: flex; justify-content: space-between; align-items: center; }
        .kpi-wrapper { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #eee; border-bottom: 4px solid #bdc3c7; }
        .kpi-val { font-size: 1.2rem; font-weight: 800; color: #2c3e50; }
        .kpi-sub { font-size: 1.1rem; color: #2980b9; font-weight: 700; }
        .kpi-lbl { font-size: 0.65rem; text-transform: uppercase; color: #777; font-weight: bold; margin-top: 4px; }
        .kpi-green { border-bottom-color: #27ae60; background: #e9f7ef; }
        #seccion-costos { display: none; margin-top: 20px; border-top: 5px solid #27ae60; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .alerta-descarte { background: #fdedec; border-left: 5px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .grid-costos { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px; }
        .bloque-costo { background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; }
        .fila-input { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .fila-input label { margin-bottom: 0; font-size: 0.7rem; color: #666; }
        .input-dinero { width: 90px; text-align: right; font-weight: bold; border: 1px solid #ddd; padding: 4px; }
        .subtotal-bloque { border-top: 1px solid #ccc; margin-top: 10px; padding-top: 5px; text-align: right; font-weight: bold; color: #2980b9; font-size: 0.9rem; }
        .gran-total { background: #ecf0f1; border: 1px solid #bdc3c7; color: #2c3e50; padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .gran-total span { font-size: 1.6rem; font-weight: bold; }
        .panel-unitarios { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; } 
        .card-unitario { background: #2c3e50; color: white; padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .card-unitario .val { font-size: 1.6rem; font-weight: bold; color: #f1c40f; }
        .card-unitario-usd { background: #16a085; } 
        #seccion-comercial { display: none; margin-top: 30px; background: #fff; padding: 25px; border-radius: 8px; border-top: 5px solid #8e44ad; box-shadow: 0 5px 20px rgba(0,0,0,0.15); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .grid-comercial { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center; }
        .input-margen-wrapper { background: #f4ecf7; padding: 20px; border-radius: 8px; border: 1px solid #d2b4de; text-align: center; }
        .input-margen-wrapper label { font-size: 0.9rem; color: #8e44ad; margin-bottom: 10px; }
        .input-margen { font-size: 2rem; width: 120px; text-align: center; border: 2px solid #8e44ad; color: #8e44ad; background: white; font-weight: bold; padding: 10px; border-radius: 6px; }
        .resultado-venta { text-align: center; background: #2c3e50; color: white; padding: 20px; border-radius: 8px; position: relative; }
        .resultado-venta h4 { color: #bdc3c7; border: none; font-size: 0.8rem; margin-bottom: 5px; }
        .precio-final { font-size: 2.5rem; color: #f1c40f; font-weight: 800; margin: 10px 0; }
        .total-fob { font-size: 1rem; color: #bdc3c7; border-top: 1px solid #7f8c8d; padding-top: 10px; margin-top: 10px; display: block; }

        /* ========================================= */
        /* PROPUESTA CLIENTE (VISUAL PANTALLA)       */
        /* ========================================= */
        #propuesta-cliente { display: none; margin-top: 40px; background: white; padding: 40px; border: 1px solid #ddd; border-top: 8px solid #2980b9; box-shadow: 0 0 30px rgba(0,0,0,0.1); position: relative; }
        .propuesta-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #2980b9; padding-bottom: 20px; }
        .propuesta-titulo { font-size: 2rem; font-weight: 900; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px; }
        .propuesta-fecha { text-align: right; color: #7f8c8d; }
        
        /* Layout Grid por defecto (Pantalla) */
        .grid-propuesta { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }

        .tabla-propuesta { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tabla-propuesta th { text-align: left; background: #f8f9fa; padding: 12px; border-bottom: 2px solid #ddd; color: #555; text-transform: uppercase; font-size: 0.8rem; }
        .tabla-propuesta td { padding: 15px 12px; border-bottom: 1px solid #eee; font-size: 1rem; color: #333; }
        .tabla-propuesta tr:last-child td { border-bottom: none; font-weight: bold; background: #fcfcfc; }
        
        .propuesta-total-card { background: #2980b9; color: white; padding: 20px; text-align: center; border-radius: 4px; margin-top: 20px; }
        .propuesta-total-card .lbl { opacity: 0.8; font-size: 0.9rem; text-transform: uppercase; }
        .propuesta-total-card .val { font-size: 2.2rem; font-weight: bold; margin-top: 5px; }

        .btn-descargar-propuesta { position: absolute; top: 20px; right: 20px; background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .btn-descargar-propuesta:hover { background: #c0392b; }

        .footer-legal { display: none; } /* Oculto en pantalla */

        /* ==================================================== */
        /* MODO PDF (Aqu√≠ hacemos la magia del reordenamiento)  */
        /* ==================================================== */
        
        /* 1. Resetear el contenedor para que parezca una hoja */
        .pdf-propuesta-mode { 
            background: white !important; 
            padding: 40px 50px !important; 
            margin: 0 !important; 
            border: none !important; 
            box-shadow: none !important; 
            font-size: 14px !important; /* Letra un poco m√°s chica para que quepa todo */
        }

        /* 2. Ocultar botones */
        .pdf-propuesta-mode .btn-descargar-propuesta,
        .pdf-propuesta-mode .btn-reiniciar { 
            display: none !important; 
        }

        /* 3. CAMBIAR GRID A BLOCK (ESTO APILA LOS ELEMENTOS) */
        .pdf-propuesta-mode .grid-propuesta {
            display: block !important;
            gap: 0;
        }

        /* 4. Estirar la tabla t√©cnica al 100% */
        .pdf-propuesta-mode .tabla-propuesta {
            width: 100% !important;
            margin-bottom: 40px !important; /* Espacio antes de los precios */
        }
        
        /* 5. Mover la secci√≥n financiera al final y alinearla a la derecha */
        .pdf-propuesta-mode .bloque-financiero {
            page-break-inside: avoid; /* Evitar que se corte */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Alinear a la derecha */
        }

        /* 6. Ajustar la tarjeta de total */
        .pdf-propuesta-mode .propuesta-total-card {
            width: 300px; /* Ancho fijo elegante */
            margin-top: 10px;
            background: #2c3e50 !important; /* Cambio de color a uno m√°s sobrio */
        }

        /* 7. Mostrar el footer legal */
        .pdf-propuesta-mode .footer-legal {
            display: block !important;
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            font-size: 0.7rem;
            color: #7f8c8d;
            text-align: center;
        }

        @media print {
            .btn-reiniciar, .btn-calc, .btn-aceptar, .btn-confirmar-costos, .btn-generar-propuesta { display: none !important; }
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="panel panel-izq" id="panel-configuracion">
        <h2>üõ†Ô∏è Datos de Carga</h2>
        <div id="controles-estiba">
            <h3>1. La Caja (mm)</h3>
            <div class="row-inputs">
                <div><label>Largo</label><input type="number" id="c_largo" value="500"></div>
                <div><label>Ancho</label><input type="number" id="c_ancho" value="300"></div>
                <div><label>Alto</label><input type="number" id="c_alto" value="230"></div>
            </div>
            <h3>2. Pesos (Kg)</h3>
            <div class="row-inputs">
                <div><label>Fruta (Neto)</label><input type="number" id="w_neto" value="17.2" step="0.1"></div>
                <div><label>Caja</label><input type="number" id="w_caja" value="0.8" step="0.1"></div>
                <div><label>Pallet</label><input type="number" id="w_pallet" value="25"></div>
            </div>
            <h3>3. Configuraci√≥n</h3>
            <div style="background:#eaf2f8; padding:10px; border-radius:6px; margin-bottom:10px;">
                <label style="color:#2980b9;">Modo Altura</label>
                <select id="modo_altura" onchange="toggleInputs()">
                    <option value="auto" selected>Autom√°tico</option>
                    <option value="manual">Manual (Filas)</option>
                </select>
                <div id="div_manual" style="display:none; margin-top:5px;">
                    <label>N¬∞ Filas</label><input type="number" id="qty_filas" value="9">
                </div>
                <div id="div_auto" style="margin-top:5px;">
                    <label>Alt. Max (mm)</label><input type="number" id="h_max" value="2300">
                </div>
            </div>
            <label>Tipo Pallet</label>
            <select id="tipoPallet">
                <option value="americano">Americano (1200x1000)</option>
                <option value="euro">Euro (1200x800)</option>
            </select>
            <label>Total Pallets</label>
            <input type="number" id="qty_pallets" value="20">
            <button class="btn-calc" onclick="calcular()">üîÑ RE-CALCULAR ESTIBA</button>
        </div>
        <button class="btn-calc btn-aceptar" onclick="aceptarEstiba()">‚úÖ ACEPTAR ESTIBA</button>
    </div>

    <div class="panel panel-der">
        <div style="overflow:hidden;">
            <h2 style="float:left;">üì¶ Plan de Carga</h2>
        </div>
        <div class="kpi-wrapper" id="kpi-dashboard"></div>

        <h3 style="text-align:center; border:none;">Esquema Unitario</h3>
        <div class="area-visual">
            <div style="text-align:center">
                <div id="zona-pallet"></div>
                <div style="font-size:0.8rem; margin-top:5px;">Base: <b id="res-base">0</b></div>
            </div>
            <div style="text-align:center">
                <div style="display:inline-block;"><div id="zona-lateral"></div></div>
                <div style="font-size:0.8rem; margin-top:5px;">Alto: <b id="res-altura">0</b> mm</div>
            </div>
        </div>
        <h3 style="text-align:center; border:none;">Distribuci√≥n Cami√≥n</h3>
        <div id="mapa-camion" class="mapa-contenedor"></div>
        
        <div id="seccion-costos">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üí∞ Estructura de Costos</h2>
                <div id="indicador-dolar" style="font-weight:bold; background:#e8f6f3; color:#16a085; padding:5px 10px; border-radius:4px;">D√≥lar: Cargando...</div>
            </div>
            <div class="alerta-descarte">
                <div>
                    <div class="alerta-titulo" style="font-weight:bold; color:#c0392b;">Materia Prima Requerida</div>
                    <div style="font-size:0.8rem;">Para obtener los <b id="kilos_export">0</b> kg del contenedor:</div>
                </div>
                <div style="text-align:right;">
                    <div class="alerta-dato" style="font-weight:bold;"><span id="kilos_recepcion">0</span> kg Recepci√≥n</div>
                    <small>Descarte: <span id="kilos_descarte">0</span> kg</small>
                </div>
            </div>
            <div class="grid-costos">
                <div class="bloque-costo">
                    <h4>1. Fruta & Proceso</h4>
                    <div class="fila-input"><label style="color:#e74c3c;">% Descarte</label><input type="number" class="input-dinero" id="pct_descarte" value="0" placeholder="%" onkeyup="calcularDinero()" style="border-color:#e74c3c; color:#c0392b;"></div>
                    <div style="border-bottom:1px dashed #ccc; margin-bottom:10px;"></div>
                    <div class="fila-input"><label>Valor Fruta ($/Kg)</label><input type="number" class="input-dinero" id="costo_fruta" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="fila-input"><label>Proceso ($/Kg)</label><input type="number" class="input-dinero" id="costo_proceso" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="subtotal-bloque" id="sub_kilos">$ 0</div>
                </div>
                <div class="bloque-costo">
                    <h4>2. Insumos & Com.</h4>
                    <div class="fila-input"><label>Caja Cart√≥n ($/Un)</label><input type="number" class="input-dinero" id="costo_caja" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="fila-input"><label>Materiales ($/Un)</label><input type="number" class="input-dinero" id="costo_materiales" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="fila-input"><label>Comisi√≥n ($/Un)</label><input type="number" class="input-dinero" id="costo_comision" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="subtotal-bloque" id="sub_cajas">$ 0</div>
                </div>
                <div class="bloque-costo">
                    <h4>3. Log√≠stica</h4>
                    <div class="fila-input"><label>Flete Campo ($)</label><input type="number" class="input-dinero" id="costo_flete_campo" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="fila-input"><label>Flete Puerto ($)</label><input type="number" class="input-dinero" id="costo_flete_puerto" placeholder="0" onkeyup="calcularDinero()"></div>
                    <div class="subtotal-bloque" id="sub_fletes">$ 0</div>
                </div>
            </div>
            <div class="gran-total">
                <div>Costo Total Contenedor (CLP)</div>
                <span id="gran_total">$ 0</span>
            </div>
            <div class="panel-unitarios">
                <div class="card-unitario"><div class="lbl">Costo/Caja CLP</div><div class="val" id="costo_unit_caja">$ 0</div></div>
                <div class="card-unitario card-unitario-usd"><div class="lbl">Costo Base USD</div><div class="val" id="costo_unit_caja_usd">US$ 0.00</div><div style="font-size:0.7rem; color:#a2ded0;">(Punto de Equilibrio)</div></div>
                <div class="card-unitario"><div class="lbl">Costo/Kg Neto</div><div class="val" id="costo_unit_kilo">$ 0</div></div>
            </div>
            <button class="btn-confirmar-costos" onclick="irAComercial()">üí≤ CONFIRMAR COSTOS Y COTIZAR</button>
        </div>

        <div id="seccion-comercial">
            <h2 style="color:#8e44ad; border-color:#d2b4de;">ü§ù Estrategia Comercial</h2>
            <div style="margin-bottom:20px; color:#555;">Define tu margen de utilidad por caja para calcular el precio de venta final al cliente.</div>
            <div class="grid-comercial">
                <div class="input-margen-wrapper">
                    <label>¬øCU√ÅNTO QUIERES GANAR POR CAJA?</label>
                    <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                        <span style="font-size:1.5rem; color:#8e44ad;">US$</span>
                        <input type="number" id="margen_usd" class="input-margen" value="1.00" step="0.1" onkeyup="calcularVenta()" onchange="calcularVenta()">
                    </div>
                    <div style="margin-top:10px; font-size:0.85rem; color:#7f8c8d;">Utilidad Total Contenedor: <b id="utilidad_total_usd" style="color:#27ae60;">US$ 0</b></div>
                </div>
                <div class="resultado-venta">
                    <h4>PRECIO DE VENTA SUGERIDO (FOB)</h4>
                    <div class="precio-final" id="precio_venta_usd">US$ 0.00</div>
                    <div class="total-fob">Valor Total Factura: <span id="total_factura_usd" style="color:white; font-weight:bold;">US$ 0</span></div>
                </div>
            </div>
            <button class="btn-generar-propuesta" onclick="generarPropuesta()">üìÑ GENERAR PROPUESTA (PDF)</button>
        </div>
    </div>
</div>

<div id="propuesta-cliente">
    <button class="btn-descargar-propuesta" onclick="descargarPDFPropuesta()">‚¨áÔ∏è DESCARGAR PDF</button>

    <div class="propuesta-header">
        <div>
            <div style="font-size:0.9rem; color:#7f8c8d; font-weight:bold;">COTIZACI√ìN DE EXPORTACI√ìN</div>
            <div class="propuesta-titulo">Propuesta Comercial</div>
        </div>
        <div class="propuesta-fecha" id="fecha-propuesta">Fecha: --/--/----</div>
    </div>

    <div class="grid-propuesta">
        <div class="bloque-tecnico">
            <h4 style="color:#2c3e50; border-bottom:2px solid #2c3e50;">1. Detalle del Producto</h4>
            <table class="tabla-propuesta">
                <tr><th>Descripci√≥n</th><td id="prop_desc">Fruta Fresca</td></tr>
                <tr><th>Formato Caja</th><td id="prop_dims">500x300x230 mm</td></tr>
                <tr><th>Peso Neto por Caja</th><td id="prop_peso">17.2 Kg</td></tr>
                <tr><th>Configuraci√≥n Pallet</th><td id="prop_config">Base 10 x 9 Alturas</td></tr>
                <tr><th>Cantidad Pallets</th><td id="prop_pallets">20 Pallets</td></tr>
                <tr><td><strong>TOTAL CAJAS</strong></td><td><strong id="prop_total_cajas" style="font-size:1.2rem;">0</strong></td></tr>
            </table>
        </div>

        <div class="bloque-financiero">
            <h4 style="color:#2c3e50; border-bottom:2px solid #2c3e50; width:100%;">2. Resumen Financiero</h4>
            
            <div style="background:#f4f6f8; padding:20px; border-radius:4px; margin-top:10px; width:100%; box-sizing:border-box;">
                <div style="font-size:0.8rem; color:#7f8c8d; margin-bottom:5px;">PRECIO UNITARIO (FOB)</div>
                <div style="font-size:2.5rem; font-weight:900; color:#2c3e50;" id="prop_precio_unit">US$ 0.00</div>
                <div style="font-size:0.9rem; font-weight:bold; color:#2980b9;">USD / Caja</div>
            </div>

            <div class="propuesta-total-card">
                <div class="lbl">TOTAL A PAGAR (USD)</div>
                <div class="val" id="prop_total_final">US$ 0,000.00</div>
            </div>

            <div style="margin-top:50px; border-top:2px solid #333; width:200px; padding-top:10px; text-align:center; font-size:0.8rem;">
                FIRMA EXPORTADOR
            </div>
        </div>
    </div>

    <div class="footer-legal">
        Este documento es una estimaci√≥n comercial v√°lida por 15 d√≠as. Los valores est√°n sujetos a confirmaci√≥n final de booking y disponibilidad de nave.
        <br>Santiago, Chile.
    </div>

    <button class="btn-reiniciar" onclick="reiniciarCalculo()">üîÑ NUEVO C√ÅLCULO</button>
</div>

<script>
    const scaleP = 0.18; const scaleL = 0.10; 
    let GLOBAL_KILOS_NETO = 0; let GLOBAL_CANT_CAJAS = 0;
    let GLOBAL_COSTO_CAJA_USD = 0; let VALOR_DOLAR_HOY = 0; 

    function formatCLP(val) { return "$ " + new Intl.NumberFormat('es-CL', { maximumFractionDigits: 0 }).format(val); }
    function formatUSD(val) { return "US$ " + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val); }

    async function obtenerDolar() {
        try {
            const response = await fetch('https://mindicador.cl/api/dolar');
            const data = await response.json();
            if (data && data.serie && data.serie.length > 0) {
                VALOR_DOLAR_HOY = data.serie[0].valor;
                document.getElementById('indicador-dolar').innerText = `D√≥lar: ${formatCLP(VALOR_DOLAR_HOY)}`;
                if(GLOBAL_CANT_CAJAS > 0) calcularDinero();
            }
        } catch (error) { console.error(error); VALOR_DOLAR_HOY = 900; document.getElementById('indicador-dolar').innerText = "D√≥lar: Manual"; }
    }

    function toggleInputs() {
        let modo = document.getElementById('modo_altura').value;
        if(modo === 'manual') { document.getElementById('div_manual').style.display = 'block'; document.getElementById('div_auto').style.display = 'none'; }
        else { document.getElementById('div_manual').style.display = 'none'; document.getElementById('div_auto').style.display = 'block'; }
        calcular();
    }

    function calcular() {
        let dims = { L: parseInt(document.getElementById('c_largo').value), W: parseInt(document.getElementById('c_ancho').value), H: parseInt(document.getElementById('c_alto').value) };
        let weights = { fruit: parseFloat(document.getElementById('w_neto').value), box: parseFloat(document.getElementById('w_caja').value), pallet: parseFloat(document.getElementById('w_pallet').value) };
        let pDim = (document.getElementById('tipoPallet').value === 'euro') ? {W:1200, L:800} : {W:1200, L:1000};
        let qtyCamion = parseInt(document.getElementById('qty_pallets').value);

        let layouts = [getLayout(pDim.W, pDim.L, dims.W, dims.L), getLayout(pDim.W, pDim.L, dims.L, dims.W), getHybrid(pDim.W, pDim.L, dims.W, dims.L), getHybrid(pDim.W, pDim.L, dims.L, dims.W)];
        layouts.sort((a,b) => b.count - a.count);
        let bestBase = layouts[0];

        let woodH = 150;
        let layers = (document.getElementById('modo_altura').value === 'manual') ? (parseInt(document.getElementById('qty_filas').value)||1) : Math.floor((parseInt(document.getElementById('h_max').value) - woodH) / dims.H);
        let totalH = (layers * dims.H) + woodH;
        let boxesPerPallet = bestBase.count * layers;
        let boxesTotal = boxesPerPallet * qtyCamion;
        let fruitPerPallet = boxesPerPallet * weights.fruit;
        let fruitTotal = fruitPerPallet * qtyCamion;
        let grossOnePallet = (boxesPerPallet * (weights.fruit + weights.box)) + weights.pallet;
        let grossTotal = grossOnePallet * qtyCamion;

        GLOBAL_KILOS_NETO = fruitTotal; GLOBAL_CANT_CAJAS = boxesTotal;

        drawPallet(pDim.W, pDim.L, bestBase.boxes);
        drawSide(layers, dims.H);
        document.getElementById('res-base').innerText = bestBase.count;
        document.getElementById('res-altura').innerText = totalH;
        drawTruckMap(qtyCamion, grossOnePallet);

        let f = new Intl.NumberFormat('es-CL');
        let cssPeso = (grossTotal > 26000) ? 'alert' : 'kpi-green';
        document.getElementById('kpi-dashboard').innerHTML = `
            <div class="kpi-card" style="border-bottom-color:#3498db; background:#ebf5fb;"><div class="kpi-val">${boxesPerPallet}</div><div class="kpi-lbl">Cajas/Pallet</div></div>
            <div class="kpi-card" style="border-bottom-color:#f1c40f; background:#fef9e7;"><div class="kpi-sub">${f.format(fruitPerPallet)} kg</div><div class="kpi-lbl">Neto (1 Plt)</div></div>
            <div class="kpi-card" style="border-bottom-color:#f1c40f; background:#fef9e7;"><div class="kpi-val">${f.format(grossOnePallet)} kg</div><div class="kpi-lbl">Bruto (1 Plt)</div></div>
            <div class="kpi-card" style="border-bottom-color:#3498db; background:#ebf5fb;"><div class="kpi-val">${f.format(boxesTotal)}</div><div class="kpi-lbl">Total Cajas</div></div>
            <div class="kpi-card kpi-green"><div class="kpi-sub">${f.format(fruitTotal)} kg</div><div class="kpi-lbl">Total Neto Exp.</div></div>
            <div class="kpi-card ${cssPeso}"><div class="kpi-val">${f.format(grossTotal)} kg</div><div class="kpi-lbl">Total Bruto</div></div>
        `;
        if(document.getElementById('seccion-costos').style.display === 'block') calcularDinero();
    }

    function aceptarEstiba() {
        document.getElementById('seccion-costos').style.display = 'block';
        document.getElementById('controles-estiba').style.opacity = '0.5';
        document.getElementById('seccion-costos').scrollIntoView({behavior: "smooth"});
        document.getElementById('pct_descarte').focus();
    }

    function calcularDinero() {
        let pct = parseFloat(document.getElementById('pct_descarte').value) || 0; if(pct >= 100) pct = 99; 
        let kilosExport = GLOBAL_KILOS_NETO;
        let kilosRecepcion = kilosExport / (1 - (pct/100));
        let kilosBasura = kilosRecepcion - kilosExport;

        let f = new Intl.NumberFormat('es-CL');
        document.getElementById('kilos_export').innerText = f.format(Math.round(kilosExport));
        document.getElementById('kilos_recepcion').innerText = f.format(Math.round(kilosRecepcion));
        document.getElementById('kilos_descarte').innerText = f.format(Math.round(kilosBasura));

        let pFruta=parseFloat(document.getElementById('costo_fruta').value)||0, pProceso=parseFloat(document.getElementById('costo_proceso').value)||0;
        let pCaja=parseFloat(document.getElementById('costo_caja').value)||0, pMat=parseFloat(document.getElementById('costo_materiales').value)||0, pCom=parseFloat(document.getElementById('costo_comision').value)||0;
        let pFleteC=parseFloat(document.getElementById('costo_flete_campo').value)||0, pFleteP=parseFloat(document.getElementById('costo_flete_puerto').value)||0;

        let tKilos = (pFruta + pProceso) * kilosRecepcion; 
        let tCajas = (pCaja + pMat + pCom) * GLOBAL_CANT_CAJAS;
        let tFletes = pFleteC + pFleteP;
        let granTotal = tKilos + tCajas + tFletes;

        let uniCaja = (GLOBAL_CANT_CAJAS > 0) ? (granTotal / GLOBAL_CANT_CAJAS) : 0;
        let uniKilo = (kilosExport > 0) ? (granTotal / kilosExport) : 0;
        GLOBAL_COSTO_CAJA_USD = (VALOR_DOLAR_HOY > 0) ? (uniCaja / VALOR_DOLAR_HOY) : 0;

        document.getElementById('sub_kilos').innerText = formatCLP(tKilos);
        document.getElementById('sub_cajas').innerText = formatCLP(tCajas);
        document.getElementById('sub_fletes').innerText = formatCLP(tFletes);
        document.getElementById('gran_total').innerText = formatCLP(granTotal);
        document.getElementById('costo_unit_caja').innerText = formatCLP(uniCaja);
        document.getElementById('costo_unit_kilo').innerText = formatCLP(uniKilo);
        document.getElementById('costo_unit_caja_usd').innerText = formatUSD(GLOBAL_COSTO_CAJA_USD);

        if(document.getElementById('seccion-comercial').style.display === 'block') calcularVenta();
    }

    function irAComercial() { document.getElementById('seccion-comercial').style.display = 'block'; document.getElementById('seccion-comercial').scrollIntoView({behavior: "smooth"}); calcularVenta(); }

    function calcularVenta() {
        let margenUSD = parseFloat(document.getElementById('margen_usd').value) || 0;
        let precioVenta = GLOBAL_COSTO_CAJA_USD + margenUSD;
        let totalFOB = precioVenta * GLOBAL_CANT_CAJAS;
        let utilidadTotal = margenUSD * GLOBAL_CANT_CAJAS;
        document.getElementById('precio_venta_usd').innerText = formatUSD(precioVenta);
        document.getElementById('total_factura_usd').innerText = formatUSD(totalFOB);
        document.getElementById('utilidad_total_usd').innerText = formatUSD(utilidadTotal);
    }

    function generarPropuesta() {
        document.getElementById('propuesta-cliente').style.display = 'block';
        document.getElementById('propuesta-cliente').scrollIntoView({behavior: "smooth"});
        let d = new Date(); document.getElementById('fecha-propuesta').innerText = `Fecha: ${d.toLocaleDateString()}`;
        document.getElementById('prop_dims').innerText = `${document.getElementById('c_largo').value}x${document.getElementById('c_ancho').value}x${document.getElementById('c_alto').value} mm`;
        document.getElementById('prop_peso').innerText = `${document.getElementById('w_neto').value} Kg Neto`;
        document.getElementById('prop_config').innerText = `Base ${document.getElementById('res-base').innerText} x ${document.getElementById('res-altura').innerText} mm Altura`;
        document.getElementById('prop_pallets').innerText = `${document.getElementById('qty_pallets').value} Pallets`;
        document.getElementById('prop_total_cajas').innerText = new Intl.NumberFormat('es-CL').format(GLOBAL_CANT_CAJAS);
        let margenUSD = parseFloat(document.getElementById('margen_usd').value) || 0;
        let precioVenta = GLOBAL_COSTO_CAJA_USD + margenUSD;
        let totalFOB = precioVenta * GLOBAL_CANT_CAJAS;
        document.getElementById('prop_precio_unit').innerText = formatUSD(precioVenta);
        document.getElementById('prop_total_final').innerText = formatUSD(totalFOB);
    }

    function reiniciarCalculo() {
        document.getElementById('seccion-costos').style.display = 'none';
        document.getElementById('seccion-comercial').style.display = 'none';
        document.getElementById('propuesta-cliente').style.display = 'none';
        document.getElementById('controles-estiba').style.opacity = '1';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function descargarPDFPropuesta() {
        const element = document.getElementById('propuesta-cliente');
        element.classList.add('pdf-propuesta-mode'); // ACTIVA EL MODO VERTICAL
        
        const opt = { 
            margin: [0.5, 0.5, 0.5, 0.5], // Margen est√°ndar de carta
            filename: 'Cotizacion_Formal.pdf', 
            image: { type: 'jpeg', quality: 0.98 }, 
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } // VUELVE A PORTRAIT (VERTICAL)
        };
        
        html2pdf().set(opt).from(element).save().then(() => {
            element.classList.remove('pdf-propuesta-mode'); // VUELVE A LA VISTA NORMAL
        });
    }

    function drawTruckMap(qty, w) { let c=document.getElementById('mapa-camion'); c.innerHTML=''; let f=new Intl.NumberFormat('es-CL'); for(let i=1;i<=qty;i++){ let d=document.createElement('div'); d.className='posicion-pallet'; d.innerHTML=`<span>P${i}</span><small>${f.format(w)} kg</small>`; c.appendChild(d); } }
    function drawPallet(PW, PL, boxes) { let z=document.getElementById('zona-pallet'); z.innerHTML=''; z.style.width=(PW*scaleP)+'px'; z.style.height=(PL*scaleP)+'px'; boxes.forEach(b=>{ let d=document.createElement('div'); d.className=b.r?'caja rotada':'caja'; d.style.left=(b.x*scaleP)+'px'; d.style.top=(b.y*scaleP)+'px'; d.style.width=(b.w*scaleP)+'px'; d.style.height=(b.h*scaleP)+'px'; z.appendChild(d); }); }
    function drawSide(layers, hBox) { let z=document.getElementById('zona-lateral'); z.innerHTML=''; z.style.height=(layers*hBox*scaleL)+'px'; for(let i=0;i<layers;i++){ let d=document.createElement('div'); d.className='capa'; d.style.height=(hBox*scaleL)+'px'; d.innerText=(i+1); z.appendChild(d); } }
    function getLayout(PW, PL, BW, BL) { let c=Math.floor(PW/BW), r=Math.floor(PL/BL), b=[]; for(let y=0;y<r;y++) for(let x=0;x<c;x++) b.push({x:x*BW, y:y*BL, w:BW, h:BL, r:false}); return {count:b.length, boxes:b}; }
    function getHybrid(PW, PL, mW, mL) { let b=[], c=Math.floor(PW/mW), r=Math.floor(PL/mL), ox=c*mW, oy=r*mL; for(let y=0;y<r;y++) for(let x=0;x<c;x++) b.push({x:x*mW, y:y*mL, w:mW, h:mL, r:false}); let rx=PW-ox; if(rx>=mL){ let c2=Math.floor(rx/mL), r2=Math.floor(PL/mW); for(let y=0;y<r2;y++) for(let x=0;x<c2;x++) b.push({x:ox+x*mL, y:y*mW, w:mL, h:mW, r:true}); } let ry=PL-oy; if(ry>=mW){ let c3=Math.floor(ox/mL), r3=Math.floor(ry/mW); for(let y=0;y<r3;y++) for(let x=0;x<c3;x++) b.push({x:x*mL, y:oy+y*mW, w:mL, h:mW, r:true}); } return {count:b.length, boxes:b}; }

    window.onload = function() { toggleInputs(); obtenerDolar(); };
</script>

</body>
</html>
